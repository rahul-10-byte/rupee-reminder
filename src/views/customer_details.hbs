<!DOCTYPE html>
<html lang="en">

{{> head}}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.all.min.js"></script>

<body>

    <div id="wrapper">

        {{> navbar}}

        {{> sidenav}}

        <button id="backToTopBtn" class="back-to-top-btn"><i class="fa-solid fa-angle-up fa-2x"></i></button>

        <!-- Page Content -->
        <div id="page-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">Customer Details</h1>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                Customer Details
                                <button class="btn btn-success btn-sm" id="addCustomer" style="float: right;"
                                    data-toggle="modal" data-target="#addModal"> + Add
                                    Customer</button>

                                <!-- Edit Modal -->
                                <div class="modal fade" id="addModal" tabindex="-1" role="dialog"
                                    aria-labelledby="editModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header"
                                                style="background:linear-gradient(to right, #b92b27, #1565c0); color:azure;">
                                                <h1 class="modal-title" id="addModalLabel">Add Customer</h1>
                                                <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="addForm">
                                                    <div class="form-group">
                                                        <label for="addCustomerName">Customer Name</label>
                                                        <input type="text" class="form-control" id="addCustomerName"
                                                            name="CustomerName">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="addCustomerEmail">Email</label>
                                                        <input type="text" class="form-control" id="addCustomerEmail"
                                                            name="CustomerEmail">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="addCustomerAddress">Address</label>
                                                        <input type="text" class="form-control" id="addCustomerAddress"
                                                            name="CustomerAddress">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="addCustomerPhone">Phone</label>
                                                        <input type="text" class="form-control" id="addCustomerPhone"
                                                            name="CustomerPhone">
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-danger"
                                                    data-dismiss="modal">Close</button>
                                                <button type="button" class="btn btn-primary"
                                                    onclick="addCustomer()">Save changes</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <!-- /.panel-heading -->
                            <div class="panel-body">
                                <table id="customer_table" style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Customer Name</th>
                                            <th>Customer Address</th>
                                            <th>Customer Email</th>
                                            <th>Customer Phone</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each customerDetails}}
                                        <tr>
                                            <td>{{this.customer_id}}</td>
                                            <td>{{this.customer_name}}</td>
                                            <td>{{this.customer_address}}</td>
                                            <td>{{this.customer_email}}</td>
                                            <td>{{this.customer_phone}}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm" id="editModalButton"
                                                    data-toggle="modal" data-target="#editModal"
                                                    data-id="{{{customer_id}}}">Edit</button>
                                            </td>
                                        </tr>
                                        {{/each}}
                                    </tbody>

                                </table>

                                <!-- Edit Modal -->
                                <div class="modal fade" id="editModal" tabindex="-1" role="dialog"
                                    aria-labelledby="editModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header"
                                                style="background:linear-gradient(to right, #b92b27, #1565c0); color:azure;">
                                                <h1 class="modal-title" id="editModalLabel">Edit Customer</h1>
                                                <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="editForm">
                                                    <div class="form-group">
                                                        <label for="editCustomerName">Customer Name</label>
                                                        <input type="text" class="form-control" id="editCustomerName"
                                                            name="CustomerName">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="editCustomerEmail">Email</label>
                                                        <input type="text" class="form-control" id="editCustomerEmail"
                                                            name="CustomerEmail">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="editCustomerAddress">Address</label>
                                                        <input type="text" class="form-control" id="editCustomerAddress"
                                                            name="CustomerAddress">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="editCustomerPhone">Phone</label>
                                                        <input type="text" class="form-control" id="editCustomerPhone"
                                                            name="CustomerPhone">
                                                    </div>
                                                    <input type="hidden" id="editEntryId" name="id">
                                                    <!-- Hidden field to store the entry ID -->
                                                </form>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-danger"
                                                    data-dismiss="modal">Close</button>
                                                <button type="button" class="btn btn-primary"
                                                    onclick="saveChanges()">Save changes</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <!-- /.col-lg-12 -->
                    </div>
                    <!-- /.row -->
                </div>
                <!-- /.container-fluid -->
            </div>
            <!-- /#page-wrapper -->

        </div>
        <!-- /#wrapper -->

    </div>
    <!-- /#wrapper -->
    {{> scripts}}


</body>

<script>
    $(document).ready(function () {
        $('#customer_table').DataTable({
            scrollX: true,
            order: [[0, 'desc']]
        });
    });

    $(document).on('click', '#editModalButton', function () {
        var row = $(this).closest('tr');

        var id = row.find('td:eq(0)').text();
        var customerName = row.find('td:eq(1)').text();
        var customerAddress = row.find('td:eq(2)').text();
        var customerEmail = row.find('td:eq(3)').text();
        var customerPhone = row.find('td:eq(4)').text();

        $('#editEntryId').val(id);
        $('#editCustomerName').val(customerName);
        $('#editCustomerEmail').val(customerEmail);
        $('#editCustomerPhone').val(customerPhone);
        $('#editCustomerAddress').val(customerAddress);

        $('#editModal').modal('show');
    });

    function addCustomer() {
        var customerName = $('#addCustomerName').val();
        var customerEmail = $('#addCustomerEmail').val();
        var customerPhone = $('#addCustomerPhone').val();
        var customerAddress = $('#addCustomerAddress').val();

        console.log(customerName, customerEmail, customerPhone, customerAddress);

        $.ajax({
            url: '/addCustomerDetails',
            type: 'POST',
            data: { customerName, customerEmail, customerPhone, customerAddress },
            success: function (response) {
                if (response.success) {
                    console.log('Entry added successfully');
                    $('#addModal').modal('hide');

                    // Show SweetAlert2 popup
                    Swal.fire({
                        icon: 'success',
                        title: 'Data Added',
                        text: 'Your data Added successfully!',
                        confirmButtonText: 'OK'
                    });
                } else {
                    console.error('Failed to update entry:', response.error);
                }
            },
            error: function (error) {
                console.error('AJAX error:', error);
            }
        });
    }

    function saveChanges() {
        var id = $('#editEntryId').val();
        var customerName = $('#editCustomerName').val();
        var customerEmail = $('#editCustomerEmail').val();
        var customerPhone = $('#editCustomerPhone').val();
        var customerAddress = $('#editCustomerAddress').val();

        console.log(id, customerName, customerEmail, customerPhone, customerAddress);

        $.ajax({
            url: '/updateCustomerDetails',
            type: 'POST',
            data: { id, customerName, customerEmail, customerPhone, customerAddress },
            success: function (response) {
                if (response.success) {
                    console.log('Entry updated successfully');
                    $('#editModal').modal('hide');

                    // Show SweetAlert2 popup
                    Swal.fire({
                        icon: 'success',
                        title: 'Data Updated',
                        text: 'Your data updated successfully!',
                        confirmButtonText: 'OK'
                    });
                } else {
                    console.error('Failed to update entry:', response.error);
                }
            },
            error: function (error) {
                console.error('AJAX error:', error);
            }
        });
    }
</script>

</html>